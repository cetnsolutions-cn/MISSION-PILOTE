<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portail Commercial Centralisé</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #1e3a8a; -webkit-animation: spinner 1s linear infinite; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Styles pour la navigation mobile */
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; flex: 1; }
        .mobile-nav-item.active { color: #2563eb; font-weight: bold; }
        
        .suggestions-list { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; border-radius: 0.5rem; z-index: 50; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; }
        .suggestion-item:hover { background-color: #eff6ff; }
        
        /* Styles pour les popups */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 400px; width: 100%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Style pour la popup d'erreur personnalisée */
        .error-popup { background: #fee2e2; border: 1px solid #fca5a5; color: #dc2626; padding: 1rem; border-radius: 0.5rem; font-size: 0.9rem; }

        /* Animation pour la corbeille */
        @keyframes trash-shake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(5deg); }
            20%, 40%, 60%, 80% { transform: rotate(-5deg); }
        }
        .animate-trash:hover svg {
            animation: trash-shake 0.5s ease-in-out;
        }
        
        /* Scrollbar hide for horizontal scroll areas */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>

    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, deleteDoc, doc, setDoc, query, orderBy, limit, getDocs, updateDoc, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // --- CONFIGURATION BDD ---
    const firebaseConfig = {
        apiKey: "AIzaSyA7-qZ8z9ET27RnWJiZBkYPsJdn3XU8ckg",
        authDomain: "rdv-message.firebaseapp.com",
        projectId: "rdv-message",
        storageBucket: "rdv-message.firebasestorage.app",
        messagingSenderId: "262090614175",
        appId: "1:262090614175:web:921a04c11d66e4d1a7c9aa",
        measurementId: "G-YCGJ44WY7L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    const { useState, useEffect, useCallback } = React;
    const { jsPDF } = window.jspdf;

    // --- ICONES & UTILS ---
    const StatusMap = {
        Pending: { label: "En attente", color: "orange" },
        Envoyé: { label: "Envoyé", color: "blue" },
        Reflection: { label: "En réflexion", color: "yellow" },
        Signed: { label: "Signé", color: "green" },
        Abandoned: { label: "Abandonné", color: "slate" },
        RequestDelete: { label: "Demande Suppr.", color: "red" }
    };

    const Icon = ({ name, size = 20, className }) => {
        const icons = {
            search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
            calendar: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
            car: '<rect x="3" y="10" width="18" height="8" rx="2"></rect><path d="M5 10l2-5h10l2 5"></path><line x1="12" y1="15" x2="12" y2="15"></line>',
            settings: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
            save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>',
            trash: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>',
            users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
            list: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
            phone: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>',
            mail: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>',
            mapPin: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>',
            link: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>',
            briefcase: '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>',
            lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
            unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
            power: '<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line>',
            eye: '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
            eyeOff: '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>',
            key: '<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>',
            layout: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>',
            fileText: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>',
            edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',
            check: '<polyline points="20 6 9 17 4 12"></polyline>',
            x: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
            refreshCw: '<path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>',
            bell: '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>',
            smile: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>'
        };
        return React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
            className: className,
            dangerouslySetInnerHTML: { __html: icons[name] || '' }
        });
    };

    const formatPhoneNumber = (value) => {
        if (!value) return value;
        const numbersOnly = value.replace(/[^\d]/g, '');
        let formatted = '';
        for (let i = 0; i < numbersOnly.length; i++) {
            if (i > 0 && i % 2 === 0) formatted += ' ';
            formatted += numbersOnly[i];
        }
        return formatted.substring(0, 14);
    };

    const generateOrderPDF = (orderData, settings) => {
        const doc = new jsPDF();
        const colors = { darkBlue: [15, 23, 42], accent: [59, 130, 246], text: [51, 65, 85], white: [255, 255, 255] };
        const taxLabel = settings.taxType || "HT";

        doc.setFillColor(...colors.darkBlue); doc.rect(0, 0, 210, 50, 'F');
        if (settings.logo) { try { doc.addImage(settings.logo, 'PNG', 15, 10, 40, 30, undefined, 'FAST'); } catch(e) {} }

        doc.setFont("helvetica", "bold"); doc.setFontSize(24); doc.setTextColor(...colors.white);
        doc.text("ORDRE DE COMMANDE", 200, 25, { align: "right" });
        doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.setTextColor(200, 200, 200);
        const refString = orderData.reference || "N/A";
        const dateToDisplay = orderData.createdAt && orderData.createdAt.seconds ? orderData.createdAt.seconds * 1000 : (orderData.createdAt || new Date());
        doc.text(`RÉF: ${refString}`, 200, 35, { align: "right" });
        doc.text(`Date: ${new Date(dateToDisplay).toLocaleDateString('fr-FR')}`, 200, 40, { align: "right" });

        doc.setFillColor(255, 255, 255); doc.roundedRect(145, 55, 55, 10, 1, 1, 'F');
        doc.setFontSize(9); doc.setFont("helvetica", "bold"); doc.setTextColor(220, 38, 38);
        doc.text("SEMAINE PILOTE - SANS ENGAGEMENT", 172.5, 61, { align: "center" });

        let y = 75;
        doc.setFontSize(9); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold"); doc.text("PRESTATAIRE", 15, y);
        doc.setFont("helvetica", "normal"); doc.setTextColor(0); y += 5;
        doc.text(settings.myCompanyName || "Votre Société", 15, y); doc.text(settings.myAddress || "", 15, y+5);
        doc.text(settings.myEmail || "", 15, y+10); if(settings.mySiret) doc.text(`SIRET: ${settings.mySiret}`, 15, y+15);

        doc.setFont("helvetica", "bold"); doc.setTextColor(...colors.darkBlue); doc.text("CLIENT", 115, 80);
        doc.setTextColor(0); doc.setFontSize(11); doc.text(orderData.companyName || "Nom Client", 115, 88);
        doc.setFont("helvetica", "normal"); doc.setFontSize(9);
        const addressLines = doc.splitTextToSize(orderData.address || "Adresse", 85); doc.text(addressLines, 115, 94);
        let yAfterAddress = 94 + (addressLines.length * 4);
        const sirenDisplay = (orderData.siren === "EN COURS") ? "EN COURS D'IMMATRICULATION" : orderData.siren;
        doc.text(`SIREN: ${sirenDisplay}`, 115, yAfterAddress);
        if(orderData.clientEmail) doc.text(orderData.clientEmail, 115, yAfterAddress + 5);

        y = 130;
        doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(...colors.darkBlue); doc.text("DÉTAILS DE LA MISSION", 15, y);
        y += 5; doc.setFillColor(...colors.darkBlue); doc.rect(15, y, 180, 10, 'F'); doc.setTextColor(...colors.white); doc.setFontSize(9);
        doc.text("DESCRIPTION", 20, y+6.5); doc.text("DÉTAIL / VALEUR", 130, y+6.5); y += 10;

        const repCount = parseInt(orderData.salesRepsCount) || 1; const repLabel = repCount > 1 ? "Commerciaux" : "Commercial";
        const rows = [
            ["Période d'essai", `Du ${new Date(orderData.startDate).toLocaleDateString('fr-FR')} au ${new Date(orderData.endDate).toLocaleDateString('fr-FR')} (7 jours)`],
            ["Type de mission", "Qualification de leads automobiles"], ["Nombre de Commerciaux", `${repCount} ${repLabel}`],
            ["Plafond RDV (Semaine Pilote)", `${orderData.maxRdvTotal || '-'} RDV Max / Semaine`],
            ["Tarif Unitaire", `${orderData.ratePerAppointment} € ${taxLabel} / RDV`],
            ["Zone d'intervention", `${orderData.radiusKm} km autour de l'agence`],
            ["Critères Véhicule", `Max ${orderData.maxKmPerVehicle} km | Année > ${orderData.minVehicleYear}`]
        ];
        if (orderData.excludedVehicles && orderData.excludedVehicles.trim() !== "") rows.push(["Modèles Exclus", orderData.excludedVehicles]);

        rows.forEach((row, i) => {
            if (i % 2 === 0) { doc.setFillColor(248, 250, 252); doc.rect(15, y, 180, 8, 'F'); }
            doc.setTextColor(...colors.text); doc.setFont("helvetica", "normal"); doc.text(row[0], 20, y+5.5);
            doc.setFont("helvetica", "bold"); doc.setTextColor(0); doc.text(row[1], 130, y+5.5);
            doc.setDrawColor(226, 232, 240); doc.line(15, y+8, 195, y+8); y += 8;
        });

        y = 225; doc.setDrawColor(200); doc.setLineWidth(0.5); doc.line(15, y-5, 195, y-5);
        doc.setFontSize(8); doc.setTextColor(...colors.text); doc.text("POUR LE PRESTATAIRE", 15, y); doc.text("Cachet et Signature :", 15, y+5);
        if (settings.stamp) { try { doc.addImage(settings.stamp, 'PNG', 15, y+8, 35, 25, undefined, 'FAST'); } catch(e) {} }
        doc.text("POUR LE CLIENT", 120, y); doc.text("Date, Cachet et Signature :", 120, y+5);
        doc.setDrawColor(200); doc.rect(120, y+13, 75, 25);

        y = 270; doc.setFontSize(7); doc.setTextColor(100); doc.setFont("helvetica", "bold"); doc.text("CONDITIONS GÉNÉRALES DE PRESTATION :", 15, y);
        doc.setFont("helvetica", "normal"); y += 4;
        const cgvLines = [
            `1. Le prestataire s'engage à fournir des rendez-vous qualifiés selon les critères définis ci-dessus.`,
            `2. Seuls les rendez-vous honorés (prospect présent au rendez-vous et qualifié) seront facturés au tarif de ${orderData.ratePerAppointment} € ${taxLabel}.`,
            `3. La durée et l'engagement de mission est valable pour une durée de une semaine (7 jours) selon les dates prédéfinies ci-dessus.`,
            `4. Mission sans engagement et sans renouvellement : à l'issue de la semaine, le client est libre d'arrêter ou de signer un contrat de collaboration.`,
            `5. Le client s'engage à fournir un accès à son agenda pour permettre la pose des créneaux.`
        ];
        cgvLines.forEach(line => { doc.text(line, 15, y); y += 3.5; });
        doc.save(`Ordre_${refString}.pdf`);
    };

    const SuccessModal = ({ isOpen, onClose, reference, isEditing }) => {
        if (!isOpen) return null;
        return React.createElement('div', { className: "modal-overlay" },
            React.createElement('div', { className: "modal-content text-center" },
                React.createElement('div', { className: "h-16 w-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 mx-auto mb-4" },
                    React.createElement(Icon, { name: "check", size: 32 })
                ),
                React.createElement('h3', { className: "text-xl font-bold text-slate-800 mb-2" }, isEditing ? "Mise à jour réussie !" : "Commande générée !"),
                React.createElement('p', { className: "text-slate-600 mb-6" }, `Le PDF de l'ordre de commande ${reference} a été ${isEditing ? 'mis à jour et téléchargé' : 'généré et téléchargé'} avec succès. Le statut est désormais : En attente.`),
                React.createElement('button', { onClick: onClose, className: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition" }, "Fermer et continuer")
            )
        );
    };

    // --- NOTIFICATION SCRIPT ---
    const NewScriptModal = ({ isOpen, onClose, onView }) => {
        if (!isOpen) return null;
        return React.createElement('div', { className: "modal-overlay" },
            React.createElement('div', { className: "modal-content text-center p-6" },
                React.createElement('div', { className: "h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mx-auto mb-4 animate-bounce" },
                    React.createElement(Icon, { name: "bell", size: 32 })
                ),
                React.createElement('h3', { className: "text-xl font-bold text-slate-800 mb-2" }, "Nouveau document disponible !"),
                React.createElement('p', { className: "text-slate-600 mb-6" }, "Un nouveau fichier a été déposé par C&N Solutions. Retrouvez-le dès maintenant dans la section Scripts."),
                React.createElement('div', { className: "flex gap-3" },
                    React.createElement('button', { onClick: onClose, className: "flex-1 px-4 py-2 border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 transition" }, "Plus tard"),
                    React.createElement('button', { onClick: onView, className: "flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition shadow-lg" }, "Voir mes scripts")
                )
            )
        );
    };

    // --- MODULE SCRIPTS (CORRIGÉ ET DÉPLACÉ) ---
    function ScriptsModule({ user, db, isAdmin }) {
        const [adminScripts, setAdminScripts] = useState([]);
        const [personalScript, setPersonalScript] = useState('');
        const [loading, setLoading] = useState(false);
        const [newPdfTitle, setNewPdfTitle] = useState('');
        const [uploading, setUploading] = useState(false);

        useEffect(() => {
            const qScripts = query(collection(db, "adminScripts"), orderBy("createdAt", "desc"));
            const unsubScripts = onSnapshot(qScripts, (snap) => {
                setAdminScripts(snap.docs.map(d => ({id: d.id, ...d.data()})));
            }, (err) => console.error(err));

            if (user && user.uid) {
                const loadPersonal = async () => {
                    try {
                        const docRef = doc(db, "users", user.uid, "private", "script");
                        const snap = await getDoc(docRef);
                        if(snap.exists()) setPersonalScript(snap.data().content || '');
                    } catch(e) { console.error(e); }
                };
                loadPersonal();
            }
            return () => unsubScripts();
        }, [db, user]);

        const handleSavePersonal = async () => {
            setLoading(true);
            try {
                const docRef = doc(db, "users", user.uid, "private", "script");
                await setDoc(docRef, { content: personalScript, updatedAt: new Date() }, { merge: true });
                alert("Vos notes personnelles sont sauvegardées !");
            } catch(e) { alert("Erreur de sauvegarde"); }
            setLoading(false);
        };

        const handleUploadPDF = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 800000) return alert("Fichier trop volumineux (Max 800ko).");
            if(file.type !== "application/pdf") return alert("Seuls les PDF sont acceptés.");

            const reader = new FileReader();
            reader.onloadend = async () => {
                setUploading(true);
                try {
                    await addDoc(collection(db, "adminScripts"), {
                        title: newPdfTitle || file.name,
                        fileData: reader.result,
                        fileName: file.name,
                        createdAt: new Date(),
                        uploadedBy: user.email
                    });
                    setNewPdfTitle('');
                    e.target.value = null;
                    alert("PDF ajouté !");
                } catch(err) { alert("Erreur envoi."); }
                setUploading(false);
            };
            reader.readAsDataURL(file);
        };

        const deleteScript = async (id) => { if(confirm("Supprimer ?")) await deleteDoc(doc(db, "adminScripts", id)); };
        const downloadPdf = (script) => {
            if(!script.fileData) return alert("Erreur fichier");
            const link = document.createElement('a');
            link.href = script.fileData; link.download = (script.title || "doc") + ".pdf";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const formatDate = (ts) => (!ts || !ts.seconds) ? "Date inconnue" : new Date(ts.seconds * 1000).toLocaleDateString();

        return React.createElement('div', { className: "max-w-6xl mx-auto space-y-6" },
            React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 p-6" },
                React.createElement('div', { className: "flex justify-between items-center mb-6" },
                    React.createElement('h2', { className: "text-xl font-bold text-slate-800 flex items-center gap-2" }, React.createElement(Icon, { name: "fileText", className: "text-blue-600" }), "Scripts & Documents Officiels"),
                    isAdmin && React.createElement('div', { className: "bg-slate-50 p-3 rounded-lg border border-slate-200 flex gap-2 items-center" },
                        React.createElement('input', { type: "text", placeholder: "Titre", value: newPdfTitle, onChange: (e) => setNewPdfTitle(e.target.value), className: "text-sm p-1 border rounded" }),
                        React.createElement('input', { type: "file", accept: "application/pdf", onChange: handleUploadPDF, className: "text-xs w-48" }),
                        uploading && React.createElement('span', { className: "text-xs text-blue-600 font-bold" }, "...")
                    )
                ),
                adminScripts.length === 0 ? React.createElement('p', { className: "text-slate-400 italic" }, "Aucun document.") :
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                    adminScripts.map(script => 
                        React.createElement('div', { key: script.id, className: "border border-slate-200 rounded-lg p-4 bg-slate-50 flex flex-col justify-between" },
                            React.createElement('div', { className: "mb-3" },
                                React.createElement('h3', { className: "font-bold text-slate-700 truncate" }, script.title || "Sans titre"),
                                React.createElement('p', { className: "text-xs text-slate-400" }, "Mis en ligne le " + formatDate(script.createdAt))
                            ),
                            React.createElement('div', { className: "flex justify-between items-center mt-2" },
                                React.createElement('button', { onClick: () => downloadPdf(script), className: "flex items-center gap-2 text-sm text-blue-600 font-bold hover:text-blue-800" }, React.createElement(Icon, { name: "download", size: 16 }), "Télécharger"),
                                isAdmin && React.createElement('button', { onClick: () => deleteScript(script.id), className: "text-red-400 hover:text-red-600 p-1" }, React.createElement(Icon, { name: "trash", size: 16 }))
                            )
                        )
                    )
                )
            ),
            React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col h-[500px]" },
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                    React.createElement('h2', { className: "text-xl font-bold text-slate-800 flex items-center gap-2" }, React.createElement(Icon, { name: "edit", className: "text-green-600" }), "Mon Script Personnel"),
                    React.createElement('button', { onClick: handleSavePersonal, disabled: loading, className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition" }, React.createElement(Icon, { name: "save", size: 18 }), loading ? "..." : "Enregistrer")
                ),
                React.createElement('textarea', { value: personalScript, onChange: (e) => setPersonalScript(e.target.value), className: "flex-1 w-full p-4 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none resize-none font-mono text-sm leading-relaxed", placeholder: "Écrivez votre script ici..." })
            )
        );
    }

    function Login({ onLogin }) {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [showPassword, setShowPassword] = useState(false);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
            e.preventDefault(); setLoading(true); setError('');
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (err) { setError("Identifiants incorrects ou compte bloqué."); setLoading(false); }
        };

        return React.createElement('div', { className: "min-h-screen flex items-center justify-center bg-slate-900 p-4" },
            React.createElement('div', { className: "bg-white rounded-xl shadow-2xl p-8 max-w-md w-full" },
                React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('h1', { className: "text-2xl font-bold text-slate-800" }, "PORTAIL PARTENAIRE"),
                    React.createElement('p', { className: "text-slate-500 text-sm mt-2" }, "Connectez-vous à votre espace centralisé.")
                ),
                React.createElement('form', { onSubmit: handleLogin, className: "space-y-6" },
                    React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Email"),
                        React.createElement('input', { type: "email", required: true, value: email, onChange: (e) => setEmail(e.target.value), className: "w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" })
                    ),
                    React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Mot de passe"),
                        React.createElement('div', { className: "relative" },
                            React.createElement('input', { type: showPassword ? "text" : "password", required: true, value: password, onChange: (e) => setPassword(e.target.value), className: "w-full border border-slate-300 rounded-lg px-4 py-2 pr-12 focus:ring-2 focus:ring-blue-500 outline-none" }),
                            React.createElement('button', { type: "button", onClick: () => setShowPassword(!showPassword), className: "absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition" }, React.createElement(Icon, { name: showPassword ? "eyeOff" : "eye", size: 20 }))
                        )
                    ),
                    error && React.createElement('p', { className: "text-red-500 text-sm text-center" }, error),
                    React.createElement('button', { type: "submit", disabled: loading, className: "w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition flex justify-center" }, loading ? "Connexion..." : "Se connecter")
                )
            )
        );
    }

    function DashboardLayout({ user, userData, globalSettings, db, isAdmin, setView, currentOrder, setCurrentOrder, allSalesReps }) {
        const [currentModule, setCurrentModule] = useState('generator');
        const [showSuccessModal, setShowSuccessModal] = useState(null);
        const [showScriptNotification, setShowScriptNotification] = useState(false);

        useEffect(() => {
            const q = query(collection(db, "adminScripts"), orderBy("createdAt", "desc"), limit(1));
            const unsubscribe = onSnapshot(q, (snap) => {
                if (!snap.empty) {
                    const latestScript = snap.docs[0].data();
                    const scriptDate = latestScript.createdAt?.seconds || 0;
                    const userLastSeen = userData?.lastSeenScriptDate?.seconds || 0;
                    if (scriptDate > userLastSeen) setShowScriptNotification(true);
                }
            });
            return () => unsubscribe();
        }, [db, userData]);

        const handleAckScript = async (goToScripts = false) => {
            setShowScriptNotification(false);
            try { await updateDoc(doc(db, "users", user.uid), { lastSeenScriptDate: new Date() }); } catch(e) {}
            if (goToScripts) setCurrentModule('scripts');
        };

        const menuItems = [
            { id: 'generator', label: 'Générateur', icon: 'layout' },
            { id: 'myOrders', label: 'Mes Demandes', icon: 'list' },
            { id: 'scripts', label: 'Scripts d\'appel', icon: 'fileText' },
            { id: 'profile', label: 'Mon Profil', icon: 'users' },
        ];

        const getRoleLabel = (role) => (role === 'admin' ? 'ADMINISTRATEUR' : role === 'intern' ? 'STAGIAIRE' : 'COMMERCIAL');
        const goToAdminTrash = () => { if(isAdmin) { setView('admin', 'trash'); } else { alert("Accès refusé."); } };

        const renderModule = () => {
            switch(currentModule) {
                case 'generator': return React.createElement(FormPanel, { user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal });
                case 'myOrders': return React.createElement(MyOrdersModule, { user, userData, db, globalSettings, setCurrentModule, setCurrentOrder, isAdmin, allSalesReps });
                case 'scripts': return React.createElement(ScriptsModule, { user, db, isAdmin });
                case 'profile': return React.createElement(CommercialProfileModule, { user, userData, db });
                default: return React.createElement(FormPanel, { user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal });
            }
        };

        return React.createElement('div', { className: "min-h-screen bg-slate-100 flex flex-col md:flex-row" },
            React.createElement('aside', { className: "hidden md:flex flex-col w-64 bg-slate-900 text-white h-screen sticky top-0" },
                React.createElement('div', { className: "p-8 border-b border-slate-800 flex flex-col items-center text-center" },
                    userData?.photoURL ? React.createElement('img', { src: userData.photoURL, className: "h-24 w-24 rounded-full object-cover border-4 border-slate-700 shadow-lg mb-4" })
                    : React.createElement('div', { className: "h-24 w-24 rounded-full bg-slate-800 border-4 border-slate-700 flex items-center justify-center text-slate-500 mb-4 shadow-lg" }, React.createElement(Icon, { name: "users", size: 40 })),
                    React.createElement('h1', { className: "font-bold text-lg tracking-tight text-white" }, userData?.name || "Utilisateur"),
                    React.createElement('div', { className: "mt-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700" }, React.createElement('p', { className: "text-[10px] text-blue-400 uppercase font-bold tracking-wider" }, getRoleLabel(userData?.role)))
                ),
                React.createElement('nav', { className: "flex-1 p-4 space-y-2 mt-4" },
                    menuItems.map(item => React.createElement('button', { key: item.id, onClick: () => setCurrentModule(item.id), className: `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${currentModule === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}` }, React.createElement(Icon, { name: item.icon, size: 20 }), React.createElement('span', { className: "font-medium" }, item.label)))
                ),
                React.createElement('div', { className: "p-4 border-t border-slate-800 space-y-2" },
                    isAdmin && React.createElement('button', { onClick: goToAdminTrash, className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-red-400 transition" }, React.createElement(Icon, { name: "trash", size: 20 }), "Corbeille"),
                    isAdmin && React.createElement('button', { onClick: () => setView('admin', 'orders'), className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-yellow-400 transition relative" }, React.createElement(Icon, { name: "settings", size: 20 }), "Administration"),
                    React.createElement('button', { onClick: () => signOut(auth), className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-400 hover:bg-red-900/20 transition" }, React.createElement(Icon, { name: "power", size: 20 }), "Déconnexion")
                )
            ),
            React.createElement('div', { className: "flex-1 flex flex-col h-screen overflow-hidden" },
                React.createElement('header', { className: "md:hidden bg-white border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        userData?.photoURL ? React.createElement('img', { src: userData.photoURL, className: "h-10 w-10 rounded-full object-cover border border-slate-200" }) : React.createElement('div', { className: "h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 border border-slate-200" }, React.createElement(Icon, { name: "users", size: 20 })),
                        React.createElement('div', null, React.createElement('h1', { className: "font-bold text-slate-800 text-sm leading-tight" }, userData?.name || "Utilisateur"), React.createElement('p', { className: "text-[10px] text-blue-600 font-bold uppercase" }, getRoleLabel(userData?.role)))
                    ),
                    React.createElement('div', { className: "flex gap-4" },
                        isAdmin && React.createElement('button', { onClick: goToAdminTrash, className: "text-slate-600" }, React.createElement(Icon, { name: "trash" })),
                        isAdmin && React.createElement('button', { onClick: () => setView('admin', 'orders'), className: "text-slate-600" }, React.createElement(Icon, { name: "settings" })),
                        React.createElement('button', { onClick: () => signOut(auth), className: "text-red-500" }, React.createElement(Icon, { name: "power" }))
                    )
                ),
                React.createElement('nav', { className: "md:hidden bg-white border-b border-gray-200 flex justify-around p-2 z-40" },
                    menuItems.map(item => React.createElement('button', { key: item.id, onClick: () => setCurrentModule(item.id), className: `mobile-nav-item ${currentModule === item.id ? 'active' : ''} p-2` }, React.createElement(Icon, { name: item.icon, size: 24 }), React.createElement('span', { className: "mt-1" }, item.label)))
                ),
                React.createElement('main', { className: "flex-1 overflow-y-auto p-4 md:p-8" }, renderModule()),
                React.createElement(SuccessModal, { isOpen: !!showSuccessModal, onClose: () => setShowSuccessModal(null), reference: showSuccessModal?.reference, isEditing: showSuccessModal?.isEditing }),
                React.createElement(NewScriptModal, { isOpen: showScriptNotification, onClose: () => handleAckScript(false), onView: () => handleAckScript(true) })
            )
        );
    }

    function MyOrdersModule({ user, db, globalSettings, setCurrentModule, setCurrentOrder, isAdmin, allSalesReps }) {
        const [orders, setOrders] = useState([]);
        const [loading, setLoading] = useState(true);
        const [deleteModal, setDeleteModal] = useState(null);
        const [selectedRepId, setSelectedRepId] = useState('Me');
        const [confirmDeleteModal, setConfirmDeleteModal] = useState(null);
        const [salesRepsMap, setSalesRepsMap] = useState({});

        useEffect(() => {
            if (allSalesReps) {
                const map = {}; allSalesReps.forEach(rep => { map[rep.id] = rep.name; });
                setSalesRepsMap(map);
            }
        }, [allSalesReps]);

        const fetchOrders = useCallback(() => {
            const ordersRef = collection(db, "orders");
            let q;
            if (isAdmin) {
                if (selectedRepId === 'All') q = query(ordersRef);
                else if (selectedRepId === 'Me') q = query(ordersRef, where("salesRepId", "==", user.uid));
                else q = query(ordersRef, where("salesRepId", "==", selectedRepId));
            } else { q = query(ordersRef, where("salesRepId", "==", user.uid)); }

            const unsubscribe = onSnapshot(q, (snap) => {
                const fetchedOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                fetchedOrders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                setOrders(fetchedOrders); setLoading(false);
            }, (error) => { console.error(error); setLoading(false); });
            return unsubscribe;
        }, [user.uid, db, selectedRepId, isAdmin]);

        useEffect(() => {
            if (!isAdmin && selectedRepId !== 'Me') setSelectedRepId('Me');
            const unsubscribe = fetchOrders(); return () => unsubscribe();
        }, [fetchOrders, isAdmin]);

        const instantDeleteOrder = async (orderId, orderRef) => {
            try { await deleteDoc(doc(db, "orders", orderId)); alert(`Commande ${orderRef} supprimée.`); setConfirmDeleteModal(null); }
            catch (e) { alert("Erreur suppression."); setConfirmDeleteModal(null); }
        };

        const handleStatusChange = async (orderId, newStatus) => {
            try { await updateDoc(doc(db, "orders", orderId), { status: newStatus === 'Envoyé' ? 'Envoyé' : newStatus }); }
            catch(e) { console.error(e); }
        };

        const submitDeleteRequest = async () => {
            if (!deleteModal.reason.trim()) return alert("Motif requis.");
            try { await updateDoc(doc(db, "orders", deleteModal.id), { status: 'RequestDelete', deleteReason: deleteModal.reason, deleteRequestDate: new Date() }); setDeleteModal(null); alert("Demande envoyée."); }
            catch(e) { alert("Erreur demande."); }
        };

        const handleEdit = (order) => { setCurrentOrder(order); setCurrentModule('generator'); };
        const getStatusColorClass = (status) => {
            const color = StatusMap[status]?.color || 'slate';
            const map = { orange: "bg-orange-50 text-orange-800 border-orange-200", blue: "bg-blue-50 text-blue-800 border-blue-200", yellow: "bg-yellow-50 text-yellow-800 border-yellow-200", green: "bg-green-50 text-green-800 border-green-200", red: "bg-red-50 text-red-800 border-red-200", slate: "bg-slate-100 text-slate-500 border-slate-200" };
            return map[color] || map.slate;
        };

        if (loading) return React.createElement('div', { className: "text-center py-10" }, "Chargement...");

        return React.createElement('div', { className: "max-w-7xl mx-auto" },
            React.createElement('h1', { className: "text-2xl font-bold text-slate-800 mb-6" }, "Liste de mes demandes"),
            isAdmin && allSalesReps && React.createElement('div', { className: "bg-white p-4 rounded-xl shadow-sm mb-6 flex items-center gap-4" },
                React.createElement('label', { className: "text-sm font-medium text-slate-700" }, "Afficher :"),
                React.createElement('select', { value: selectedRepId, onChange: (e) => setSelectedRepId(e.target.value), className: "border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white font-medium" },
                    React.createElement('option', { value: "Me" }, "Mes demandes"), React.createElement('option', { value: "All" }, "Toutes"),
                    allSalesReps.filter(rep => rep.id !== user.uid).map(rep => React.createElement('option', { key: rep.id, value: rep.id }, rep.name))
                )
            ),
            orders.length === 0 ? React.createElement('p', { className: "text-slate-500 bg-white p-6 rounded-xl shadow-sm" }, "Aucune commande.") :
            React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                React.createElement('div', { className: "overflow-x-auto" },
                    React.createElement('table', { className: "w-full text-left" },
                        React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                            React.createElement('tr', null, React.createElement('th', { className: "p-2 md:p-3" }, "Réf & Client"), React.createElement('th', { className: "p-2 md:p-3 hidden md:table-cell" }, "Commercial"), React.createElement('th', { className: "p-2 md:p-3" }, "Statut"), React.createElement('th', { className: "p-2 md:p-3 hidden md:table-cell" }, "Date"), React.createElement('th', { className: "p-2 md:p-3 text-right" }, "Actions"))
                        ),
                        React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                            orders.map(o => React.createElement('tr', { key: o.id, className: "hover:bg-slate-50 transition-colors" },
                                React.createElement('td', { className: "p-2 md:p-3" }, React.createElement('div', { className: "font-mono font-bold text-blue-600" }, o.reference), React.createElement('div', { className: "text-slate-700 font-medium truncate max-w-[120px] md:max-w-none" }, o.companyName)),
                                React.createElement('td', { className: "p-2 md:p-3 hidden md:table-cell text-indigo-600 font-medium" }, salesRepsMap[o.salesRepId] || o.salesRepName || 'N/A'),
                                React.createElement('td', { className: "p-2 md:p-3" }, o.status === 'RequestDelete' ? React.createElement('span', { className: "bg-red-100 text-red-800 text-[10px] px-2 py-1 rounded-full font-bold border border-red-200" }, StatusMap[o.status].label) : React.createElement('select', { value: o.status === 'Generated' ? 'Envoyé' : o.status, onChange: (e) => handleStatusChange(o.id, e.target.value), className: `text-[11px] font-bold rounded-lg block p-1.5 border outline-none cursor-pointer transition ${getStatusColorClass(o.status === 'Generated' ? 'Envoyé' : o.status)}` }, Object.keys(StatusMap).filter(k => k !== 'RequestDelete' && k !== 'Abandoned').map(key => React.createElement('option', { key: key, value: key }, StatusMap[key].label)), React.createElement('option', { value: "Abandoned" }, StatusMap.Abandoned.label))),
                                React.createElement('td', { className: "p-2 md:p-3 hidden md:table-cell whitespace-nowrap text-slate-500" }, o.createdAt.seconds ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : '-'),
                                React.createElement('td', { className: "p-2 md:p-3 text-right" }, React.createElement('div', { className: "flex justify-end gap-2 flex-wrap" },
                                    React.createElement('button', { onClick: () => generateOrderPDF(o, globalSettings), className: "text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition" }, React.createElement(Icon, { name: "download", size: 16 })),
                                    o.status !== 'Signed' && o.status !== 'RequestDelete' && React.createElement('button', { onClick: () => handleEdit(o), className: "text-indigo-600 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-lg transition" }, React.createElement(Icon, { name: "edit", size: 16 })),
                                    o.status !== 'RequestDelete' && (isAdmin ? React.createElement('button', { onClick: () => setConfirmDeleteModal({ id: o.id, ref: o.reference }), className: "text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" }, React.createElement(Icon, { name: "trash", size: 16 })) : React.createElement('button', { onClick: () => setDeleteModal({ id: o.id, reference: o.reference, reason: '' }), className: "text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" }, React.createElement(Icon, { name: "trash", size: 16 })))
                                ))
                            ))
                        )
                    )
                )
            ),
            deleteModal && React.createElement('div', { className: "modal-overlay" }, React.createElement('div', { className: "modal-content" }, React.createElement('h3', { className: "text-xl font-bold text-red-600 mb-4" }, "Suppression"), React.createElement('p', { className: "text-slate-600 mb-4" }, `Demander suppression de ${deleteModal.reference} ?`), React.createElement('textarea', { className: "w-full border border-slate-300 rounded-lg p-2 mb-6", placeholder: "Motif obligatoire", value: deleteModal.reason, onChange: (e) => setDeleteModal({...deleteModal, reason: e.target.value}) }), React.createElement('div', { className: "flex justify-end gap-3" }, React.createElement('button', { onClick: () => setDeleteModal(null), className: "px-4 py-2 bg-slate-100 rounded-lg" }, "Annuler"), React.createElement('button', { onClick: submitDeleteRequest, disabled: !deleteModal.reason.trim(), className: "px-4 py-2 text-white bg-red-600 rounded-lg" }, "Envoyer")))),
            confirmDeleteModal && React.createElement('div', { className: "modal-overlay" }, React.createElement('div', { className: "modal-content" }, React.createElement('h3', { className: "text-xl font-bold text-red-700 mb-4" }, "CONFIRMER"), React.createElement('p', { className: "text-slate-600 mb-6" }, `Supprimer ${confirmDeleteModal.ref} DÉFINITIVEMENT ?`), React.createElement('div', { className: "flex justify-end gap-3" }, React.createElement('button', { onClick: () => setConfirmDeleteModal(null), className: "px-4 py-2 bg-slate-100 rounded-lg" }, "Annuler"), React.createElement('button', { onClick: () => instantDeleteOrder(confirmDeleteModal.id, confirmDeleteModal.ref), className: "px-4 py-2 text-white bg-red-600 rounded-lg" }, "Supprimer"))))
        );
    }

    function FormPanel({ user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal }) {
        const [loading, setLoading] = useState(false);
        const [isSiretPending, setIsSiretPending] = useState(false);
        const [isDifferentAddress, setIsDifferentAddress] = useState(false);
        const [addressSuggestions, setAddressSuggestions] = useState([]);
        const [error, setError] = useState('');
        const [civility, setCivility] = useState('M.');
        const [firstName, setFirstName] = useState('');
        const [lastName, setLastName] = useState('');

        const initialFormState = { siren: '', companyName: '', address: '', clientEmail: '', clientPhone: '', startDate: new Date().toISOString().split('T')[0], endDate: '', radiusKm: 20, maxKmPerVehicle: 100000, minVehicleYear: 2018, excludedVehicles: '', salesRepsCount: 0, maxRdvTotal: 0 };
        const [form, setForm] = useState(initialFormState);
        const isEditing = !!currentOrder?.id;

        useEffect(() => {
            if (isEditing) {
                setForm({
                    siren: currentOrder.siren === "EN COURS" ? '' : currentOrder.siren || '', companyName: currentOrder.companyName || '', address: currentOrder.address || '', clientEmail: currentOrder.clientEmail || '', clientPhone: formatPhoneNumber(currentOrder.clientPhone) || '', startDate: currentOrder.startDate || new Date().toISOString().split('T')[0], endDate: currentOrder.endDate || '',
                    radiusKm: parseInt(currentOrder.radiusKm) || 20, maxKmPerVehicle: parseInt(currentOrder.maxKmPerVehicle) || 100000, minVehicleYear: parseInt(currentOrder.minVehicleYear) || 2018, excludedVehicles: currentOrder.excludedVehicles || '', salesRepsCount: parseInt(currentOrder.salesRepsCount) || 0, maxRdvTotal: parseInt(currentOrder.maxRdvTotal) || 0
                });
                setIsSiretPending(currentOrder.siren === "EN COURS");
                setIsDifferentAddress((currentOrder.siren === "EN COURS") || (currentOrder.address !== currentOrder.companyAddressFromAPI));
                if (currentOrder.siren === "EN COURS" && currentOrder.companyName) { const parts = currentOrder.companyName.split(' '); setCivility(parts[0] || 'M.'); setFirstName(parts[1] || ''); setLastName(parts.slice(2).join(' ') || ''); }
            } else { setForm(initialFormState); setIsSiretPending(false); setIsDifferentAddress(false); setError(''); }
        }, [isEditing, currentOrder]);

        useEffect(() => { if (form.startDate) { let d = new Date(form.startDate); d.setDate(d.getDate() + 7); setForm(prev => ({...prev, endDate: d.toISOString().split('T')[0]})); } }, [form.startDate]);

        const searchSiren = async () => {
            if (form.siren.length < 9) return alert("SIREN invalide"); setLoading(true); setError('');
            try {
                const res = await fetch(`https://recherche-entreprises.api.gouv.fr/search?q=${form.siren}`); const data = await res.json();
                if (data.results && data.results.length > 0) { const c = data.results[0]; setForm(prev => ({...prev, companyName: c.nom_complet, address: c.siege.adresse, companyAddressFromAPI: c.siege.adresse })); setIsDifferentAddress(false); } else setError("SIREN introuvable.");
            } catch (e) { setError("Erreur API."); } setLoading(false);
        };

        const handleAddressSearch = async (q) => {
            setForm(prev => ({...prev, address: q}));
            if(q.length > 3) { try { const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${q}&limit=5`); const d = await res.json(); setAddressSuggestions(d.features || []); } catch(e) {} } else setAddressSuggestions([]);
        };

        const handleSave = async () => {
            setError('');
            let finalName = form.companyName;
            if (isSiretPending) { if(!lastName || !firstName) return setError("Nom/Prénom requis."); finalName = `${civility} ${firstName} ${lastName}`; }
            if (!finalName || !form.address) return setError("Identité client incomplète.");
            if (form.clientPhone.replace(/\s/g, '').length !== 10) return setError("Téléphone invalide.");
            if (!form.maxRdvTotal || parseInt(form.maxRdvTotal) <= 0) return setError("Plafond RDV obligatoire.");

            setLoading(true);
            try {
                const settingsRef = doc(db, "settings", "global"); const settingsSnap = await getDoc(settingsRef);
                let currentSeq = globalSettings.sequenceNumber || 367;
                let refString = currentOrder?.reference;
                if (!isEditing) {
                    if (settingsSnap.exists()) currentSeq = settingsSnap.data().sequenceNumber || 367;
                    const d = new Date(); refString = `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}-${currentSeq}`;
                }
                const orderData = { ...form, companyName: finalName, salesRepName: userData?.name || user.email, salesRepId: user.uid, ratePerAppointment: globalSettings.defaultRate, siren: isSiretPending ? "EN COURS" : form.siren, reference: refString, clientPhone: form.clientPhone.replace(/\s/g, ''), createdAt: isEditing ? currentOrder.createdAt : new Date(), status: isEditing ? currentOrder.status : 'Pending', updatedAt: new Date() };
                
                let oid = currentOrder?.id;
                if (isEditing) await updateDoc(doc(db, "orders", oid), orderData);
                else { oid = (await addDoc(collection(db, "orders"), orderData)).id; await updateDoc(settingsRef, { sequenceNumber: parseInt(currentSeq) + 1 }); globalSettings.sequenceNumber = parseInt(currentSeq) + 1; }
                
                generateOrderPDF({...orderData, id: oid}, globalSettings);
                setShowSuccessModal({ reference: refString, isEditing: isEditing });
                setForm(initialFormState); setCurrentOrder(null); setCurrentModule('myOrders');
            } catch (e) { setError("Erreur: " + e.message); }
            setLoading(false);
        };

        return React.createElement('div', { className: "max-w-5xl mx-auto" },
            isEditing && React.createElement('div', { className: "bg-indigo-100 border border-indigo-200 p-4 rounded-xl mb-6 flex justify-between items-center" }, React.createElement('p', { className: "font-bold text-indigo-800" }, `ÉDITION : ${currentOrder.reference}`), React.createElement('button', { onClick: () => setCurrentOrder(null), className: "text-indigo-600" }, "Annuler")),
            error && React.createElement('div', { className: "error-popup mb-6" }, error),
            React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-6" },
                React.createElement('div', { className: "lg:col-span-2 space-y-6" },
                    React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                        React.createElement('div', { className: "flex justify-between items-center mb-4" }, React.createElement('h2', { className: "text-lg font-semibold flex items-center gap-2" }, React.createElement(Icon, { name: "search", className: "text-blue-600" }), "1. Identification"), React.createElement('label', { className: "flex items-center gap-2 text-xs font-semibold bg-slate-100 px-3 py-1 rounded-full" }, React.createElement('input', { type: "checkbox", checked: isSiretPending, onChange: (e) => { setIsSiretPending(e.target.checked); setForm(prev => ({...prev, companyName: '', address: '', siren: ''})); setIsDifferentAddress(false); }, disabled: isEditing }), "SIRET en cours")),
                        !isSiretPending ? React.createElement('div', { className: "flex gap-3 mb-4" }, React.createElement('input', { type: "text", placeholder: "SIREN", value: form.siren, onChange: (e) => setForm({...form, siren: e.target.value.substring(0, 9)}), className: "flex-1 border rounded-lg px-4 py-2" }), React.createElement('button', { onClick: searchSiren, disabled: loading, className: "bg-slate-800 text-white px-5 py-2 rounded-lg" }, "Rechercher"))
                        : React.createElement('div', { className: "grid grid-cols-3 gap-3 mb-4" }, React.createElement('select', { value: civility, onChange: (e) => setCivility(e.target.value), className: "border rounded-lg p-2" }, React.createElement('option', { value: "M." }, "M."), React.createElement('option', { value: "Mme" }, "Mme")), React.createElement('input', { type: "text", placeholder: "Prénom", value: firstName, onChange: (e) => setFirstName(e.target.value), className: "border rounded-lg p-2" }), React.createElement('input', { type: "text", placeholder: "Nom", value: lastName, onChange: (e) => setLastName(e.target.value), className: "border rounded-lg p-2" })),
                        (form.companyName && !isSiretPending) && React.createElement('div', { className: "bg-blue-50 p-4 rounded-lg mb-4" }, React.createElement('p', { className: "font-bold text-blue-900" }, form.companyName), !isDifferentAddress && React.createElement('p', { className: "text-blue-700 text-sm" }, form.address)),
                        React.createElement('div', { className: "mb-4" }, React.createElement('label', { className: "flex gap-2 text-sm mb-2" }, React.createElement('input', { type: "checkbox", checked: isDifferentAddress || isSiretPending, onChange: (e) => { setIsDifferentAddress(e.target.checked); if(e.target.checked) setForm(prev => ({...prev, address: ''})); }, disabled: isSiretPending }), "Adresse différente ?"), (isDifferentAddress || isSiretPending) && React.createElement('div', null, React.createElement('input', { type: "text", placeholder: "Adresse...", value: form.address, onChange: (e) => handleAddressSearch(e.target.value), className: "w-full border rounded-lg p-2" }), addressSuggestions.length > 0 && React.createElement('div', { className: "suggestions-list" }, addressSuggestions.map((s, i) => React.createElement('div', { key: i, className: "suggestion-item", onClick: () => { setForm(prev => ({...prev, address: s.properties.label})); setAddressSuggestions([]); } }, s.properties.label))))),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Email"), React.createElement('input', { type: "email", value: form.clientEmail, onChange: (e) => setForm({...form, clientEmail: e.target.value}), className: "w-full border rounded-lg p-2" })), React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Téléphone"), React.createElement('input', { type: "tel", value: form.clientPhone, onChange: (e) => setForm(prev => ({...prev, clientPhone: formatPhoneNumber(e.target.value)})), className: "w-full border rounded-lg p-2" })))
                    ),
                    React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                        React.createElement('h2', { className: "text-lg font-semibold mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "users", className: "text-green-600" }), "2. Objectifs"),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Commerciaux"), React.createElement('input', { type: "number", value: form.salesRepsCount, onChange: (e) => setForm({...form, salesRepsCount: parseInt(e.target.value)}), className: "w-full border rounded-lg p-2" })), React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Plafond RDV"), React.createElement('input', { type: "number", value: form.maxRdvTotal, onChange: (e) => setForm({...form, maxRdvTotal: parseInt(e.target.value)}), className: "w-full border rounded-lg p-2" })))
                    ),
                    React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                        React.createElement('h2', { className: "text-lg font-semibold mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "calendar", className: "text-orange-500" }), "3. Période"),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Début"), React.createElement('input', { type: "date", value: form.startDate, onChange: (e) => setForm({...form, startDate: e.target.value}), className: "w-full border rounded-lg p-2 text-blue-600 font-bold" })), React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Fin"), React.createElement('input', { type: "date", value: form.endDate, disabled: true, className: "w-full border rounded-lg p-2 bg-slate-50" }))),
                        React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Tarif"), React.createElement('div', { className: "bg-slate-50 p-2 rounded border" }, `${globalSettings.defaultRate} € ${globalSettings.taxType || 'HT'}`))
                    )
                ),
                React.createElement('div', { className: "space-y-6" },
                    React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                        React.createElement('h2', { className: "text-lg font-semibold mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "car", className: "text-purple-500" }), "4. Véhicule"),
                        React.createElement('div', { className: "space-y-4" },
                            React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Rayon (km)"), React.createElement('input', { type: "number", value: form.radiusKm, onChange: (e) => setForm({...form, radiusKm: parseInt(e.target.value)}), className: "w-full border rounded-lg p-2" })),
                            React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Max Km"), React.createElement('input', { type: "number", value: form.maxKmPerVehicle, onChange: (e) => setForm({...form, maxKmPerVehicle: parseInt(e.target.value)}), className: "w-full border rounded-lg p-2" })),
                            React.createElement('div', null, React.createElement('label', { className: "text-xs block mb-1" }, "Année Min"), React.createElement('input', { type: "number", value: form.minVehicleYear, onChange: (e) => setForm({...form, minVehicleYear: parseInt(e.target.value)}), className: "w-full border rounded-lg p-2" })),
                            React.createElement('div', { className: "pt-4 border-t" }, React.createElement('label', { className: "text-xs block mb-1 text-red-500 font-bold" }, "Exclus"), React.createElement('input', { type: "text", value: form.excludedVehicles, onChange: (e) => setForm({...form, excludedVehicles: e.target.value}), className: "w-full border border-red-200 bg-red-50 rounded-lg p-2 text-red-700" }))
                        )
                    ),
                    React.createElement('button', { onClick: handleSave, disabled: loading, className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-3" }, loading ? "..." : (isEditing ? "METTRE À JOUR" : "GÉNÉRER PDF"))
                )
            )
        );
    }

    function CommercialProfileModule({ user, userData, db }) {
        const [firstName, setFirstName] = useState(userData?.firstName || '');
        const [lastName, setLastName] = useState(userData?.lastName || '');
        const [isEditing, setIsEditing] = useState(false);
        const [msg, setMsg] = useState('');

        const handleSave = async (e) => {
            e.preventDefault();
            const newName = `${firstName} ${lastName}`;
            try {
                await updateDoc(doc(db, "users", user.uid), { firstName, lastName, name: newName });
                if(newName !== userData.name) await addDoc(collection(db, "nameChanges"), { userId: user.uid, userEmail: user.email, oldName: userData.name, newName, timestamp: new Date() });
                setMsg("Mis à jour !"); setIsEditing(false);
            } catch(e) { setMsg("Erreur."); }
        };

        const handlePhoto = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onloadend = async () => { await updateDoc(doc(db, "users", user.uid), { photoURL: r.result }); setMsg("Photo OK"); }; r.readAsDataURL(f);
        };

        return React.createElement('div', { className: "max-w-2xl mx-auto space-y-6" },
            React.createElement('div', { className: "bg-white rounded-xl shadow-sm border p-8" },
                React.createElement('div', { className: "flex items-center gap-6 mb-8" },
                    React.createElement('div', { className: "relative group" },
                        userData?.photoURL ? React.createElement('img', { src: userData.photoURL, className: "h-20 w-20 rounded-full object-cover" }) : React.createElement('div', { className: "h-20 w-20 bg-blue-100 rounded-full flex items-center justify-center" }, React.createElement(Icon, { name: "users", size: 32 })),
                        React.createElement('label', { className: "absolute inset-0 flex items-center justify-center bg-black/50 text-white rounded-full opacity-0 group-hover:opacity-100 cursor-pointer" }, "Modifier", React.createElement('input', { type: "file", className: "hidden", onChange: handlePhoto }))
                    ),
                    React.createElement('div', null, React.createElement('h2', { className: "text-2xl font-bold" }, userData?.name), React.createElement('p', { className: "text-slate-500" }, user.email))
                ),
                msg && React.createElement('div', { className: "bg-green-100 text-green-800 p-2 rounded mb-4" }, msg),
                !isEditing ? React.createElement('button', { onClick: () => setIsEditing(true), className: "w-full bg-indigo-600 text-white py-2 rounded" }, "Modifier")
                : React.createElement('form', { onSubmit: handleSave, className: "space-y-4" },
                    React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('input', { value: firstName, onChange: e=>setFirstName(e.target.value), className: "border p-2 rounded" }), React.createElement('input', { value: lastName, onChange: e=>setLastName(e.target.value), className: "border p-2 rounded" })),
                    React.createElement('div', { className: "flex gap-2" }, React.createElement('button', { type: "button", onClick: ()=>setIsEditing(false), className: "w-1/2 bg-slate-200 py-2 rounded" }, "Annuler"), React.createElement('button', { type: "submit", className: "w-1/2 bg-blue-600 text-white py-2 rounded" }, "Enregistrer"))
                )
            ),
            React.createElement(StaticProfileModule, { user, userData, db })
        );
    }

    function StaticProfileModule({ user, userData }) {
        return React.createElement('div', { className: "bg-white rounded-xl shadow-sm border p-8" },
            React.createElement('h3', { className: "font-bold mb-4" }, "Infos"),
            React.createElement('p', { className: "mb-2" }, "Rôle: " + userData?.role),
            React.createElement('p', { className: "font-mono text-sm text-slate-500" }, "ID: " + user.uid)
        );
    }

    function AdminPanel({ setView, globalSettings, setGlobalSettings, db, defaultTab, setAdminTab }) {
        const [orders, setOrders] = useState([]);
        const [users, setUsers] = useState([]);
        const [nameLogs, setNameLogs] = useState([]);
        const [tab, setTab] = useState(defaultTab || 'orders');
        const [newUser, setNewUser] = useState({ name: '', email: '', password: '', role: 'sales' });
        const [editingId, setEditingId] = useState(null);

        useEffect(() => { if (defaultTab && defaultTab !== tab) setTab(defaultTab); }, [defaultTab]);
        useEffect(() => {
            const u1 = onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(100)), s => setOrders(s.docs.map(d=>({id:d.id, ...d.data()}))));
            const u2 = onSnapshot(collection(db, "users"), s => setUsers(s.docs.map(d=>({id:d.id, ...d.data()}))));
            const u3 = onSnapshot(query(collection(db, "nameChanges"), orderBy("timestamp", "desc")), s => setNameLogs(s.docs.map(d=>({id:d.id, ...d.data()}))));
            return () => { u1(); u2(); u3(); };
        }, []);

        const trashOrders = orders.filter(o => o.status === 'RequestDelete');
        const handleTabChange = (t) => { setTab(t); setAdminTab(t); };
        
        const saveUser = async (e) => {
            e.preventDefault();
            if(editingId) { await updateDoc(doc(db, "users", editingId), { name: newUser.name, role: newUser.role }); setEditingId(null); }
            else { try { const uc = await createUserWithEmailAndPassword(secondaryAuth, newUser.email, newUser.password); await setDoc(doc(db, "users", uc.user.uid), { ...newUser, createdAt: new Date() }); signOut(secondaryAuth); } catch(e) { alert(e.message); } }
            setNewUser({ name: '', email: '', password: '', role: 'sales' });
        };

        const deleteNameLog = async (id) => { if(confirm("Supprimer ?")) await deleteDoc(doc(db, "nameChanges", id)); };
        const deleteAllNameLogs = async () => { if(confirm("Tout supprimer ?")) { const b = writeBatch(db); nameLogs.forEach(l=>b.delete(doc(db,"nameChanges",l.id))); await b.commit(); }};
        const handleImageUpload = (e, f) => { const r = new FileReader(); r.onloadend = () => setGlobalSettings(p => ({...p, [f]: r.result})); if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
        const saveSettings = async () => { await setDoc(doc(db, "settings", "global"), globalSettings, { merge: true }); alert("OK"); };

        return React.createElement('div', { className: "min-h-screen bg-slate-900 p-4" },
            React.createElement('div', { className: "max-w-7xl mx-auto" },
                React.createElement('div', { className: "flex gap-4 mb-6 overflow-x-auto" }, ['orders', 'trash', 'history', 'team', 'clients', 'settings'].map(t => React.createElement('button', { key: t, onClick: () => handleTabChange(t), className: `px-4 py-2 rounded text-white ${tab===t?'bg-blue-600':'bg-slate-700'}` }, t.toUpperCase()))),
                tab === 'team' && React.createElement('div', null,
                    React.createElement('form', { onSubmit: saveUser, className: "bg-slate-800 p-4 rounded mb-4" }, React.createElement('input', { placeholder: "Nom", value: newUser.name, onChange: e=>setNewUser({...newUser, name: e.target.value}), className: "p-2 mr-2" }), React.createElement('input', { placeholder: "Email", value: newUser.email, onChange: e=>setNewUser({...newUser, email: e.target.value}), className: "p-2 mr-2" }), !editingId && React.createElement('input', { placeholder: "Mdp", value: newUser.password, onChange: e=>setNewUser({...newUser, password: e.target.value}), className: "p-2 mr-2" }), React.createElement('button', { className: "bg-green-600 text-white p-2 rounded" }, editingId ? "Update" : "Créer")),
                    users.map(u => React.createElement('div', { key: u.id, className: "bg-white p-2 mb-2 rounded flex justify-between" }, React.createElement('span', null, u.name + " (" + u.email + ")"), React.createElement('button', { onClick: ()=>setEditingId(u.id), className: "text-blue-600" }, "Edit")))
                ),
                tab === 'history' && React.createElement('div', null, React.createElement('button', { onClick: deleteAllNameLogs, className: "bg-red-600 text-white px-4 py-2 rounded mb-4" }, "Vider Historique"), nameLogs.map(l => React.createElement('div', { key: l.id, className: "bg-white p-2 mb-2 rounded flex justify-between" }, React.createElement('span', null, `${l.oldName} -> ${l.newName} (${l.userEmail})`), React.createElement('button', { onClick: ()=>deleteNameLog(l.id) }, "X")))),
                tab === 'settings' && React.createElement('div', { className: "bg-slate-800 p-6 rounded text-white" }, 
                    React.createElement('h3', null, "Paramètres"), 
                    React.createElement('input', { type: "file", onChange: e=>handleImageUpload(e, 'logo') }),
                    React.createElement('button', { onClick: saveSettings, className: "bg-blue-600 px-4 py-2 rounded mt-4" }, "Sauvegarder")
                )
            )
        );
    }

    function App() {
        const [user, setUser] = useState(null);
        const [userData, setUserData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [view, setView] = useState('dashboard');
        const [currentOrder, setCurrentOrder] = useState(null);
        const [allSalesReps, setAllSalesReps] = useState(null);
        const [adminTab, setAdminTab] = useState('orders');
        const [globalSettings, setGlobalSettings] = useState({ defaultRate: 50, taxType: 'HT', sequenceNumber: 367 });

        useEffect(() => {
            const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                if (currentUser) {
                    onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            let data = { role: 'sales', ...docSnap.data() };
                            if (currentUser.email === "contact@cetn-solutions.fr" && data.role !== 'admin') data.role = 'admin';
                            if (data.isBlocked) { signOut(auth); alert("Bloqué"); setUser(null); }
                            else { setUser(currentUser); setUserData(data); }
                        } else { signOut(auth); setUser(null); }
                        setLoading(false);
                    });
                } else { setUser(null); setLoading(false); }
            });
            return () => unsubscribe();
        }, []);

        useEffect(() => { if(user) getDoc(doc(db, "settings", "global")).then(s => s.exists() && setGlobalSettings(p => ({...p, ...s.data()}))); }, [user]);
        useEffect(() => { if (userData?.role === 'admin' || user?.email === 'contact@cetn-solutions.fr') onSnapshot(query(collection(db, "users")), s => setAllSalesReps(s.docs.map(d=>({id:d.id, ...d.data()})))); }, [userData, user]);

        if (loading) return React.createElement('div', { className: "min-h-screen flex items-center justify-center" }, React.createElement('div', { className: "loader h-8 w-8 rounded-full border-4 border-slate-200" }));
        if (!user) return React.createElement(Login);
        if (view === 'admin' && (userData?.role === 'admin' || user?.email === 'contact@cetn-solutions.fr')) return React.createElement(AdminPanel, { setView: (v, t) => { setView(v); if(t) setAdminTab(t); }, globalSettings, setGlobalSettings, db, currentUser: user, defaultTab: adminTab, setAdminTab });
        
        return React.createElement(DashboardLayout, { user, userData, globalSettings, db, isAdmin: (userData?.role === 'admin' || user?.email === 'contact@cetn-solutions.fr'), setView: (v, t) => { setView(v); if(t) setAdminTab(t); }, currentOrder, setCurrentOrder, allSalesReps });
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
    </script>
</body>
</html>
